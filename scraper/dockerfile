# Étape 1 : Construire le binaire
FROM golang:latest AS builder

# Arguments de build pour le versioning
ARG VERSION=dev
ARG GIT_COMMIT=unknown
ARG BUILD_TIME=unknown

WORKDIR /go_api_mongo_scrapper

# Copier les fichiers de dépendances
COPY go.mod go.sum ./
RUN go mod download

# Copier le reste du code source
COPY . .

# Construire le binaire avec versioning
RUN CGO_ENABLED=0 GOOS=linux go build \
    -ldflags="-s -w -X main.version=${VERSION} -X main.gitCommit=${GIT_COMMIT} -X main.buildTime=${BUILD_TIME}" \
    -o scraper ./scraper/scraper.go

# Étape 2 : Image finale minimale
FROM scratch

# Redéclarer les arguments pour cette étape
ARG VERSION=dev
ARG GIT_COMMIT=unknown
ARG BUILD_TIME=unknown

# Copier les certificats CA pour HTTPS
COPY --from=builder /etc/ssl/certs/ca-certificates.crt /etc/ssl/certs/

WORKDIR /go_api_mongo_scrapper

# Copier le binaire
COPY --from=builder /go_api_mongo_scrapper/scraper /go_api_mongo_scrapper/

# Labels pour traçabilité
LABEL version="${VERSION}" \
      git.commit="${GIT_COMMIT}" \
      build.time="${BUILD_TIME}" \
      maintainer="Maxime Louis <maxime.louis14@example.com>" \
      description="Go API MongoDB Scrapper - Scraper Service" \
      org.opencontainers.image.source="https://github.com/maxime-louis14/go_api_mongo_scrapper"

# Variables d'environnement par défaut
ENV SCRAPER_MAX_WORKERS=10 \
    SCRAPER_TIMEOUT=30s \
    SCRAPER_BASE_URL=https://www.allrecipes.com \
    LOG_LEVEL=info

# Démarrer l'application
ENTRYPOINT ["/go_api_mongo_scrapper/scraper"]